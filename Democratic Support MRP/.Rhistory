setwd("~/Code Projects/Democratic Support MRP")
library(tidyverse)
library(haven)
df <- read_dta('marist_feb.dta')
head(df)
summary(df$BSDT2020)
summary(as_factor(df$BSDT2020))
summary(as_factor(df$JSDT2020))
summary(as_factor(df$JBDT2020))
head(df$BSDT2020)
df %>%
mutate(sanders = recode(as.numeric(BSDT2020),`1`=1,`2`=0,.default=NA_real_),
biden = recode(as.numeric(JBDT2020),`1`=1,`2`=0,.default=NA_real_)) %>%
select(sanders,biden)
library(Hmisc)
df %>%
mutate(sanders = recode(as.numeric(BSDT2020),`1`=1,`2`=0,.default=NA_real_),
biden = recode(as.numeric(JBDT2020),`1`=1,`2`=0,.default=NA_real_)) %>%
summarise_at(vars(sanders,biden),~wtd.mean(.x,wtfactor,na.rm=T))
library(Hmisc)
install.packages('digest')
library(Hmisc)
df %>%
mutate(sanders = recode(as.numeric(BSDT2020),`1`=1,`2`=0,.default=NA_real_),
biden = recode(as.numeric(JBDT2020),`1`=1,`2`=0,.default=NA_real_)) %>%
summarise_at(vars(sanders,biden),~wtd.mean(.x,wtfactor,na.rm=T))
head(df$collegep)
summary(df$collegep)
head(df$INC15WT)
df %>%
mutate(sanders = recode(as.numeric(BSDT2020),`1`=1,`2`=0,.default=NA_real_),
biden = recode(as.numeric(JBDT2020),`1`=1,`2`=0,.default=NA_real_),
educ = recode(as.numeric(collep),`1`=0,`2`=1,.default=NA_real_),
income = as_factor(na_if(INC15WT,9)),
race = as_factor(na_if(RACEWTL2),9)) %>%
select(sanders,biden,educ,income,race,wtfactor)
df %>%
mutate(sanders = recode(as.numeric(BSDT2020),`1`=1,`2`=0,.default=NA_real_),
biden = recode(as.numeric(JBDT2020),`1`=1,`2`=0,.default=NA_real_),
educ = recode(as.numeric(collegp),`1`=0,`2`=1,.default=NA_real_),
income = as_factor(na_if(INC15WT,9)),
race = as_factor(na_if(RACEWTL2),9)) %>%
select(sanders,biden,educ,income,race,wtfactor)
df %>%
mutate(sanders = recode(as.numeric(BSDT2020),`1`=1,`2`=0,.default=NA_real_),
biden = recode(as.numeric(JBDT2020),`1`=1,`2`=0,.default=NA_real_),
educ = recode(as.numeric(collegep),`1`=0,`2`=1,.default=NA_real_),
income = as_factor(na_if(INC15WT,9)),
race = as_factor(na_if(RACEWTL2),9)) %>%
select(sanders,biden,educ,income,race,wtfactor)
df %>%
mutate(sanders = recode(as.numeric(BSDT2020),`1`=1,`2`=0,.default=NA_real_),
biden = recode(as.numeric(JBDT2020),`1`=1,`2`=0,.default=NA_real_),
educ = recode(as.numeric(collegep),`1`=0,`2`=1,.default=NA_real_),
income = as_factor(na_if(INC15WT,9)),
race = as_factor(na_if(RACEWTL2,9))) %>%
select(sanders,biden,educ,income,race,wtfactor)
df %>%
mutate(sanders = recode(as.numeric(BSDT2020),`1`=1,`2`=0,.default=NA_real_),
biden = recode(as.numeric(JBDT2020),`1`=1,`2`=0,.default=NA_real_),
educ = recode(as.numeric(collegep),`1`=0,`2`=1,.default=NA_real_),
income = as_factor(na_if(INC15WT,9)),
race = as_factor(na_if(RACEWTL2,9))) %>%
filter_at(vars(sanders,biden,educ,income,race,wtfactor),~!is.na(.x)) %>%
select(sanders,biden,educ,income,race,wtfactor)
head(df$gender)
head(df$states)
df %>%
mutate(sanders = recode(as.numeric(BSDT2020),`1`=1,`2`=0,.default=NA_real_),
biden = recode(as.numeric(JBDT2020),`1`=1,`2`=0,.default=NA_real_),
educ = recode(as.numeric(collegep),`1`=0,`2`=1,.default=NA_real_),
income = as_factor(na_if(INC15WT,9)),
race = as_factor(na_if(RACEWTL2,9)),
gender = as.numeric(gender==2),
statefip = states) %>%
filter_at(vars(sanders,biden,educ,income,race,wtfactor),~!is.na(.x)) %>%
select(sanders,biden,educ,income,race,gender,statefip,wtfactor)
library(lme4)
df %>%
mutate(sanders = recode(as.numeric(BSDT2020),`1`=1,`2`=0,.default=NA_real_),
biden = recode(as.numeric(JBDT2020),`1`=1,`2`=0,.default=NA_real_),
educ = recode(as.numeric(collegep),`1`=0,`2`=1,.default=NA_real_),
income = as_factor(na_if(INC15WT,9)),
race = as_factor(na_if(RACEWTL2,9)),
gender = as.numeric(gender==2),
statefip = states) %>%
filter_at(vars(sanders,biden,educ,income,race,wtfactor),~!is.na(.x)) %>%
select(sanders,biden,educ,income,race,gender,statefip,wtfactor) -> data
context <- read_csv('contextual_data.csv')
df %>%
mutate(sanders = recode(as.numeric(BSDT2020),`1`=1,`2`=0,.default=NA_real_),
biden = recode(as.numeric(JBDT2020),`1`=1,`2`=0,.default=NA_real_),
educ = recode(as.numeric(collegep),`1`=0,`2`=1,.default=NA_real_),
income = as_factor(na_if(INC15WT,9)),
race = as_factor(na_if(RACEWTL2,9)),
gender = as.numeric(gender==2),
statefip = states) %>%
filter_at(vars(sanders,biden,educ,income,race,wtfactor),~!is.na(.x)) %>%
select(sanders,biden,educ,income,race,gender,statefip,wtfactor) %>%
inner_join(context) -> data
data
res.sanders <- glmer(sanders ~ (1|educ) + (1|race) + (1|gender) + (1|income) + (1|state) + median_hh_income + black + hispanic + evangelical + obama,data,family=binomial)
summary(res.sanders)
res.sanders <- glmer(sanders ~ (1|educ) + (1|race) + (1|gender) + (1|income) + (1|state) + median_hh_income + black + hispanic + evangelical,data,family=binomial)
summary(res.sanders)
res.sanders <- glmer(sanders ~ (1|educ) + (1|race) + (1|gender) + (1|income) + median_hh_income + black + hispanic + evangelical,data,family=binomial)
res.sanders <- glmer(sanders ~ (1|educ) + (1|race) + (1|gender) + (1|income) + median_hh_income + black + hispanic + evangelical + obama,data,family=binomial)
summary(res.sanders)
ranefs(res.sanders)
ranef(res.sanders)
res.sanders <- glmer(sanders ~ (1|educ) + (1|race) + (1|gender) + (1|income) + (1|race:educ) + median_hh_income + black + hispanic + evangelical + obama,data,family=binomial)
summary(res.sanders)
ranef(res.sanders)
res.sanders <- glmer(sanders ~ (1|educ) + (1|race) + (1|gender) + (1|income) + (1|race:educ) + (1|income:race) + median_hh_income + black + hispanic + evangelical + obama,data,family=binomial)
summary(res.sanders)
ranef(res.sanders)
df$INCREC50
head(df$INCREC50)
df %>%
mutate(sanders = recode(as.numeric(BSDT2020),`1`=1,`2`=0,.default=NA_real_),
biden = recode(as.numeric(JBDT2020),`1`=1,`2`=0,.default=NA_real_),
educ = recode(as.numeric(collegep),`1`=0,`2`=1,.default=NA_real_),
income = as_factor(na_if(INCREC50,9)),
race = as_factor(na_if(RACEWTL2,9)),
gender = as.numeric(gender==2),
statefip = states) %>%
filter_at(vars(sanders,biden,educ,income,race,wtfactor),~!is.na(.x)) %>%
select(sanders,biden,educ,income,race,gender,statefip,wtfactor) %>%
inner_join(context) -> data
res.sanders <- glmer(sanders ~ (1|educ) + (1|race) + (1|gender) + (1|income) + (1|race:educ) + (1|income:race) + median_hh_income + black + hispanic + evangelical + obama,data,family=binomial)
res.sanders <- glmer(sanders ~ (1|educ) + (1|race) + (1|gender) + (1|income) + (1|race:educ) + (1|state) + median_hh_income + black + hispanic + evangelical + obama,data,family=binomial)
summary(res.sanders)
ranef(res.sanders)
res.biden <- glmer(biden ~ (1|educ) + (1|race) + (1|gender) + (1|income) + (1|race:educ) + (1|state) + median_hh_income + black + hispanic + evangelical + obama,data,family=binomial)
summary(res.biden)
res.biden <- glmer(biden ~ (1|educ) + (1|race) + (1|gender) + (1|income) + (1|state) + median_hh_income + black + hispanic + evangelical + obama,data,family=binomial)
summary(res.biden)
res.biden <- glmer(biden ~ (1|educ) + (1|race) + (1|gender) + (1|income) + median_hh_income + black + hispanic + evangelical + obama,data,family=binomial)
summary(res.biden)
res.biden <- glmer(biden ~ (1|educ) + (1|race) + (1|gender) + (1|income) + (1|race:educ) + median_hh_income + black + hispanic + evangelical + obama,data,family=binomial)
res.biden <- glmer(biden ~ (1|educ) + (1|race) + (1|gender) + (1|income) + (1|gender:educ) + median_hh_income + black + hispanic + evangelical + obama,data,family=binomial)
res.biden <- glmer(biden ~ (1|educ) + (1|race) + (1|gender) + (1|income) + median_hh_income + black + hispanic + evangelical + obama,data,family=binomial)
summary(res.biden)
ranef(res.biden)
df$totalrv
df %>%
mutate(sanders = recode(as.numeric(BSDT2020),`1`=1,`2`=0,.default=NA_real_),
biden = recode(as.numeric(JBDT2020),`1`=1,`2`=0,.default=NA_real_),
educ = recode(as.numeric(collegep),`1`=0,`2`=1,.default=NA_real_),
income = as_factor(na_if(INCREC50,9)),
race = as_factor(na_if(RACEWTL2,9)),
gender = as.numeric(gender==2),
statefip = states) %>%
filter_at(vars(sanders,biden,educ,income,race,wtfactor),~!is.na(.x)) %>%
filter(totalrv==1) %>%
select(sanders,biden,educ,income,race,gender,statefip,wtfactor) %>%
inner_join(context) -> data
head(df$totalsmp)
turnout <- read_dta('cps_00177.dta')
df %>%
mutate(sanders = recode(as.numeric(BSDT2020),`1`=1,`2`=0,.default=NA_real_),
biden = recode(as.numeric(JBDT2020),`1`=1,`2`=0,.default=NA_real_),
educ = recode(as.numeric(collegep),`1`=0,`2`=1,.default=NA_real_),
income = as_factor(na_if(INCREC50,9)),
race = as_factor(na_if(RACEWTL2,9)),
gender = as.numeric(gender==2),
age = as_factor(na_if(ageepwt,9)),
statefip = states) %>%
filter_at(vars(sanders,biden,educ,income,race,wtfactor),~!is.na(.x)) %>%
filter(totalrv==1) %>%
select(sanders,biden,educ,income,race,gender,age,statefip,wtfactor) %>%
inner_join(context) -> data
data
head(data$income)
summary(data$income)
df %>%
mutate(sanders = recode(as.numeric(BSDT2020),`1`=1,`2`=0,.default=NA_real_),
biden = recode(as.numeric(JBDT2020),`1`=1,`2`=0,.default=NA_real_),
educ = recode(as.numeric(collegep),`1`=0,`2`=1,.default=NA_real_),
income = droplevels(as_factor(na_if(INCREC50,9))),
race = as_factor(na_if(RACEWTL2,9)),
gender = as.numeric(gender==2),
age = as_factor(na_if(ageepwt,9)),
statefip = states) %>%
filter_at(vars(sanders,biden,educ,income,race,wtfactor),~!is.na(.x)) %>%
filter(totalrv==1) %>%
select(sanders,biden,educ,income,race,gender,age,statefip,wtfactor) %>%
inner_join(context) -> data
summary(data$income)
df %>%
mutate(sanders = recode(as.numeric(BSDT2020),`1`=1,`2`=0,.default=NA_real_),
biden = recode(as.numeric(JBDT2020),`1`=1,`2`=0,.default=NA_real_),
educ = recode(as.numeric(collegep),`1`=0,`2`=1,.default=NA_real_),
income = droplevels(as_factor(na_if(INCREC50,9))),
race = droplevels(as_factor(na_if(RACEWTL2,9))),
gender = as.numeric(gender==2),
age = droplevels(as_factor(na_if(ageepwt,9))),
statefip = states) %>%
filter_at(vars(sanders,biden,educ,income,race,wtfactor),~!is.na(.x)) %>%
filter(totalrv==1) %>%
select(sanders,biden,educ,income,race,gender,age,statefip,wtfactor) %>%
inner_join(context) -> data
summary(data$race)
turnout$faminc
head(data$income)
head(data$age)
turnout %>%
filter(faminc < 995,age>=18,voted<96,educ<999) %>%
mutate(income = case_when(faminc <= 740 ~ 'Less than $50,000',
faminc >= 800 ~ '$50,000 or more'),
educ = as.numeric(educ>100),
race = case_when(race == 100 & hispan == 0 ~ 'White',
race == 200 & hispan == 0 ~ 'African-American',
hispan != 0 ~ 'Hispanic',
TRUE ~ 'Asian-Other'),
age = case_when(age <= 29 ~ '18 to 29',
age >= 30 & age < 45 ~ '30 to 44',
age >= 45 & age < 60 ~ '45 to 59',
age >= 60 ~ '60 or older'),
gender = as.numeric(sex==2),
vote = as.numeric(voted == 2)) %>%
mutate(income = factor(income,levels=c('Less than $50,000','$50,000 or more')),
race = factor(race,levels=c('White','African-American','Hispanic','Asian-Other')),
age = factor(age,levels=c('18 to 29','30 to 44','45 to 59','60 or older'))) %>%
select(statefip,income,race,educ,age,gender,vote) %>%
inner_join(context) -> turnout
res.turnout <- glmer(vote ~ (1|educ) + (1|race) + (1|gender) + (1|income) + vap2012,turnout,family=binomial)
res.turnout <- glmer(vote ~ (1|educ) + (1|race) + (1|gender) + (1|income) + (1|educ:race) + (1|educ:gender) + (1|race:gender) + (1|state) + (1|race:state) + vap2012,turnout,family=binomial)
summary(res.turnout)
census <- read_dta('usa_00068.dta')
census %>%
filter(age>=18) %>%
mutate(gender = as.numeric(sex==2),
race = case_when(race == 1 & hispan == 0 ~ 'White',
race == 2 & hispan == 0 ~ 'African-American',
hispan != 0 ~ 'Hispanic',
TRUE ~ 'Asian-Other'),
educ = as.numeric(educ > 9),
income = factor(ifelse(ftotinc>=50000,'$50,000 or more','Less than $50,000'),levels=c('Less than $50,000','$50,000 or more')),
age = case_when(age <= 29 ~ '18 to 29',
age >= 30 & age < 45 ~ '30 to 44',
age >= 45 & age < 60 ~ '45 to 59',
age >= 60 ~ '60 or older')) %>%
mutate(income = factor(income,levels=c('Less than $50,000','$50,000 or more')),
race = factor(race,levels=c('White','African-American','Hispanic','Asian-Other')),
age = factor(age,levels=c('18 to 29','30 to 44','45 to 59','60 or older'))) %>%
group_by(statefip,gender,race,educ,income,age) %>%
summarise(n = sum(perwt)) %>%
inner_join(context) -> pstrat
ranef(res.turnout)
pstrat$turnout <- predict(res.turnout,pstrat,type='response',allow.new.levels=T)
summary(res.sanders)
ranef(res.sanders)
pstrat$sanders <- predict(res.sanders,pstrat,type='response',allow.new.levels=T)
pstrat$biden <- predict(res.biden,pstrat,type='response',allow.new.levels=T)
pstrat
pstrat %>%
mutate(n_votes = n*turnout) %>%
group_by(income) %>%
summarise_at(vars(biden,sanders),~wtd.mean(.x,n_votes,na.rm = T))
pstrat %>%
mutate(n_votes = n*turnout) %>%
group_by(educ) %>%
summarise_at(vars(biden,sanders),~wtd.mean(.x,n_votes,na.rm = T))
pstrat %>%
mutate(n_votes = n*turnout) %>%
group_by(educ,race) %>%
summarise_at(vars(biden,sanders),~wtd.mean(.x,n_votes,na.rm = T))
pstrat %>%
mutate(n_votes = n*turnout) %>%
group_by(state) %>%
summarise_at(vars(biden,sanders),~wtd.mean(.x,n_votes,na.rm = T))
pstrat %>%
mutate(n_votes = n*turnout) %>%
group_by(state) %>%
summarise_at(vars(biden,sanders),~wtd.mean(.x,n_votes,na.rm = T)) %>%
write_csv('mrp_results.csv')
pstrat %>%
mutate(n_votes = n*turnout) %>%
summarise_at(vars(biden,sanders),~wtd.mean(.x,n_votes,na.rm = T))
pstrat %>%
ungroup() %>%
mutate(n_votes = n*turnout) %>%
summarise_at(vars(biden,sanders),~wtd.mean(.x,n_votes,na.rm = T))
wtd.mean(data$sanders,wtfactor)
wtd.mean(data$sanders,data$wtfactor)
wtd.mean(data$biden,data$wtfactor)
res.sanders <- glmer(sanders ~ (1|educ) + (1|race) + (1|gender) + (1|income) + (1|race:educ) + (1|gender:educ) + median_hh_income + black + hispanic + evangelical + obama,data,family=binomial)
res.sanders <- glmer(sanders ~ (1|educ) + (1|race) + (1|gender) + (1|income) + (1|race:educ) + (1|gender:educ) + (1|race:income) + median_hh_income + black + hispanic + evangelical + obama,data,family=binomial)
summary(res.sanders)
res.biden <- glmer(biden ~ (1|educ) + (1|race) + (1|gender) + (1|income) + (1|race:educ) + (1|gender:educ) + (1|race:income) + median_hh_income + black + hispanic + evangelical + obama,data,family=binomial)
summary(res.biden)
res.biden <- glmer(biden ~ (1|educ) + (1|race) + (1|gender) + (1|income) + (1|gender:educ) + (1|race:income) + median_hh_income + black + hispanic + evangelical + obama,data,family=binomial)
summary(res.biden)
res.biden <- glmer(biden ~ (1|educ) + (1|race) + (1|gender) + (1|income) + (1|gender:educ) + median_hh_income + black + hispanic + evangelical + obama,data,family=binomial)
summary(res.biden)
res.biden <- glmer(biden ~ (1|educ) + (1|race) + (1|gender) + (1|income) + median_hh_income + black + hispanic + evangelical + obama,data,family=binomial)
summary(res.biden)
pstrat$biden <- predict(res.biden,pstrat,type='response',allow.new.levels=T)
pstrat %>%
mutate(n_votes = n*turnout) %>%
group_by(state) %>%
summarise_at(vars(biden,sanders),~wtd.mean(.x,n_votes,na.rm = T)) %>%
write_csv('mrp_results.csv')
pstrat %>%
ungroup() %>%
mutate(n_votes = n*turnout) %>%
summarise_at(vars(biden,sanders),~wtd.mean(.x,n_votes,na.rm = T))
res.sanders <- glmer(sanders ~ income*state + (1|educ) + (1|race) + (1|gender) + (1|income) + (1|race:educ) + (1|gender:educ) + (1|race:income) + median_hh_income + black + hispanic + evangelical + obama,data,family=binomial)
marist <- read_dta('marist_feb.dta')
marist %>%
mutate(sanders = recode(as.numeric(BSDT2020),`1`=1,`2`=0,.default=NA_real_),
biden = recode(as.numeric(JBDT2020),`1`=1,`2`=0,.default=NA_real_),
educ = recode(as.numeric(collegep),`1`=0,`2`=1,.default=NA_real_),
income = droplevels(as_factor(na_if(INCREC50,9))),
race = droplevels(as_factor(na_if(RACEWTL2,9))),
gender = as.numeric(gender==2),
age = droplevels(as_factor(na_if(ageepwt,9))),
statefip = states) %>%
filter_at(vars(sanders,biden,educ,income,race,wtfactor),~!is.na(.x)) %>%
filter(totalrv==1) %>%
select(sanders,biden,educ,income,race,gender,age,statefip,wtfactor)
cnn <- read_dta('cnn_march.dta')
cnn
head(cnn$RACE1_4)
View(cnn)
